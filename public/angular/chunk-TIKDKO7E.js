import{a as F,c as P}from"./chunk-ZE5ZDUB2.js";import{a as U}from"./chunk-2AVGDEVC.js";import{a as j}from"./chunk-VGOS47CB.js";import{b as I}from"./chunk-4NPP5BVZ.js";import{a as R,g as O}from"./chunk-VBE3IEDN.js";import{a as L,d as B}from"./chunk-VN6LWNMF.js";import{f as k}from"./chunk-UYQAHJAI.js";import{Ab as r,Bb as i,Cb as l,Gb as T,Jb as u,Pb as b,Qb as g,Rb as y,Sb as x,Tb as a,Ub as _,Ya as s,Yb as C,Za as p,d as E,ha as V,qa as c,qb as m,ra as h,rc as M,wb as f,yb as v,zb as S}from"./chunk-LRPHIVML.js";var $=["streamervideo"],N=["streamedvideo"];function A(o,e){if(o&1&&(r(0,"mat-chip"),a(1),i()),o&2){let t=e.$implicit;s(),_("@"+t)}}function W(o,e){if(o&1&&(r(0,"h2"),a(1),i()),o&2){let t=e.$implicit;s(),_(t)}}var Q=class o{constructor(e,t){this._authenticateService=e;this._matSnackBar=t;this.loggedIn=this._authenticateService.loggedIn,this.userData=this._authenticateService.user_data,M(()=>{(this.loggedIn()||!this.loggedIn())&&this.connection.readyState==1&&this.becomePyaara()})}startStreamDisabled=!0;stopStreamDisabled=!0;connection;mediaRecorder;streamerVideo;streamedVideo;baseUrl=`${k.baseUrl}/video/`;ms;sb;loggedIn;userData;showStreamerVideo=!0;showStreamedVideo=!0;usertext=[];userName=[];ngOnInit(){this.connect(),this.ms=new MediaSource,this.streamedVideo.nativeElement.src=URL.createObjectURL(this.ms),this.ms.addEventListener("sourceopen",()=>{this.sb=this.ms.addSourceBuffer('video/webm; codecs="vp8, opus"')})}connect(){let e=k.wsVideoBaseUrl;this.connection=new WebSocket(e),this.connection.onopen=()=>{console.log("connection open",this.connection.readyState),this.startStreamDisabled=!1,this.connection.readyState==1&&this.connection.send(this.userData().username==""?"\u092A\u094D\u092F\u093E\u0930\u093E":this.userData().username)},this.connection.onmessage=t=>{typeof t.data=="string"?this.streamText(t.data):this.streamVideo(t.data)},this.connection.onerror=t=>{console.error("WebSocket error:",t)},this.connection.onclose=()=>{console.log("WebSocket connection closed")}}becomePyaara(){this.connection.send(this.userData().username==""?"\u092A\u094D\u092F\u093E\u0930\u093E":this.userData().username)}checkLength(){this.usertext.length==15&&this.usertext.pop()}sendText(e){this.checkLength(),this.usertext.unshift(`@${this.userData().username==""?"\u092A\u094D\u092F\u093E\u0930\u093E":this.userData().username} : ${e.trim()}`),this.connection.send(`T9${e.trim()}`)}streamText(e){e=="ignore"||(e=="locked"?(this.startStreamDisabled=!0,this.stopStreamDisabled=!0):e=="unlocked"?(this.startStreamDisabled=!1,this.stopStreamDisabled=!0,this.ms.endOfStream()):e.includes("T9")?(this.checkLength(),this.usertext.unshift(e.split("T9")[1])):this.userName=e.split(","))}timeSet=!1;streamVideo(e){return E(this,null,function*(){this.showStreamedVideo=!1;let t=yield e.arrayBuffer();this.ms.readyState==="open"&&typeof this.sb<"u"&&typeof e<"u"&&this.sb.appendBuffer(t),this.timeSet==!1&&this.sb.buffered.length!=0&&(this.setTime(),this.timeSet=!0)})}startStream(){this.showStreamerVideo=!1,this.connection.send("locked"),navigator.mediaDevices.getUserMedia({audio:{channelCount:2,echoCancellation:!0,noiseSuppression:!0},video:{facingMode:"environment",frameRate:{ideal:24}}}).then(e=>{this.startStreamDisabled=!0,this.stopStreamDisabled=!1,this.streamerVideo.nativeElement.srcObject=e,this.mediaRecorder=new MediaRecorder(e,{audioBitsPerSecond:30*1e3,videoBitsPerSecond:300*1e3,mimeType:'video/webm; codecs="vp8, opus"'}),this.mediaRecorder.ondataavailable=t=>{this.connection.send(t.data)},this.mediaRecorder.onstop=()=>{e.getTracks().forEach(t=>t.stop()),this.connection.send("unlocked"),this.showStreamerVideo=!1,this.startStreamDisabled=!1,this.stopStreamDisabled=!0},this.mediaRecorder.start(200)})}endStream(){this.mediaRecorder.stop()}setTime(){this.streamedVideo.nativeElement.currentTime=this.streamedVideo.nativeElement.seekable.end(0),this.streamedVideo.nativeElement.currentTime>0&&!this.streamedVideo.nativeElement.paused&&!this.streamedVideo.nativeElement.ended?setTimeout(this.setTime,1e4):this.streamedVideo.nativeElement.paused&&setTimeout(this.setTime,1e3)}ngOnDestroy(){this.connection.close()}static \u0275fac=function(t){return new(t||o)(p(I),p(j))};static \u0275cmp=V({type:o,selectors:[["app-livestream"]],viewQuery:function(t,n){if(t&1&&(b($,7),b(N,7)),t&2){let d;g(d=y())&&(n.streamerVideo=d.first),g(d=y())&&(n.streamedVideo=d.first)}},standalone:!0,features:[C],decls:36,vars:5,consts:[["streamervideo",""],["streamedvideo",""],["message",""],[2,"display","flex","justify-content","center"],["height","300px","width","400px","autoplay","","controls","","muted","",1,"center",3,"hidden"],["height","300px","width","400px","autoplay","","controls","",1,"center",3,"hidden"],[1,"center",3,"hidden"],["mat-stroked-button","","color","accent",3,"click","disabled"],["mat-stroked-button","","color","error",3,"click","disabled"],[1,"center"],[2,"width","80%","margin","auto","text-align","center"],["aria-label","Fish selection"],["matInput",""],["mat-stroked-button","","color","primary",3,"click"]],template:function(t,n){if(t&1){let d=T();r(0,"div",3),l(1,"video",4,0)(3,"video",5,1),i(),l(5,"br"),r(6,"div",6)(7,"button",7),u("click",function(){return c(d),h(n.startStream())}),a(8,"Go Live"),i(),a(9,`
\xA0
`),r(10,"button",8),u("click",function(){return c(d),h(n.endStream())}),a(11,"End Live"),i()(),l(12,"br"),r(13,"p",9),a(14,"Un-mute the video."),i(),r(15,"p",9),a(16,"If stream stops , try pulling the seek button till the end."),i(),r(17,"p",9),a(18,"Only one logged in user can be live at a time. "),i(),r(19,"p",9),a(20,"Refresh before going live if someone was live before you. "),i(),r(21,"div",10)(22,"mat-chip-set",11)(23,"mat-chip"),a(24,"Users online :"),i(),v(25,A,2,1,"mat-chip",null,f),i(),r(27,"mat-form-field")(28,"mat-label"),a(29,"message:"),i(),l(30,"input",12,2),i(),r(32,"button",13),u("click",function(){c(d);let D=x(31);return h([n.sendText(D.value),D.value=""])}),a(33,"Send"),i(),v(34,W,2,1,"h2",null,f),i()}t&2&&(s(),m("hidden",n.showStreamerVideo),s(2),m("hidden",n.showStreamedVideo),s(3),m("hidden",!n.loggedIn()),s(),m("disabled",n.startStreamDisabled),s(3),m("disabled",n.stopStreamDisabled),s(15),S(n.userName),s(9),S(n.usertext))},dependencies:[B,L,P,F,O,R,U],styles:["video[_ngcontent-%COMP%]{margin:auto}"]})};export{Q as LivestreamComponent};
