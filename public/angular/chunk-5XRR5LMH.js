import{a as N,c as A}from"./chunk-JMUZB376.js";import{a as Q}from"./chunk-OQJTPVCI.js";import{a as $}from"./chunk-57VX2FDE.js";import{a as j,g as P}from"./chunk-YF2K7AJ4.js";import{b as R}from"./chunk-25A3FC3X.js";import{a as F,d as U}from"./chunk-K4OZBMFI.js";import"./chunk-DKCBBMDY.js";import{c as O,d as D,g as p,i as E}from"./chunk-6XXA7HXI.js";import{f as w}from"./chunk-MJRUFRT7.js";import{Ab as l,Eb as M,Hb as u,Nb as g,Ob as y,Pb as _,Qb as I,Rb as a,Sb as k,Wb as L,Ya as s,Za as f,d as x,ha as C,ob as m,pc as B,qa as c,ra as h,ub as v,wb as S,xb as b,yb as r,zb as i}from"./chunk-CZHVG3FW.js";var q=["streamervideo"],G=["streamedvideo"];function Y(o,e){if(o&1&&(r(0,"mat-chip"),a(1),i()),o&2){let t=e.$implicit;s(),k("@"+t)}}function z(o,e){if(o&1&&(r(0,"h2"),a(1),i()),o&2){let t=e.$implicit;s(),k(t)}}var W=class o{constructor(e,t){this._authenticateService=e;this._matSnackBar=t;this.loggedIn=this._authenticateService.loggedIn,this.userData=this._authenticateService.user_data,B(()=>{(this.loggedIn()||!this.loggedIn())&&this.connection.readyState==1&&this.becomePyaara()})}startStreamDisabled=!0;stopStreamDisabled=!0;connection;mediaRecorder;streamerVideo;streamedVideo;baseUrl=`${w.baseUrl}/video/`;ms;sb;loggedIn;userData;showStreamerVideo=!0;showStreamedVideo=!0;usertext=[];userName=[];ngOnInit(){this.connect(),this.ms=new MediaSource,this.streamedVideo.nativeElement.src=URL.createObjectURL(this.ms),this.ms.addEventListener("sourceopen",()=>{this.sb=this.ms.addSourceBuffer('video/webm; codecs="vp8, opus"')})}connect(){let e=w.wsVideoBaseUrl;this.connection=new WebSocket(e),this.connection.onopen=()=>{console.log("connection open",this.connection.readyState),this.startStreamDisabled=!1,this.connection.readyState==1&&this.connection.send(this.userData().username==""?"\u092A\u094D\u092F\u093E\u0930\u093E":this.userData().username)},this.connection.onmessage=t=>{typeof t.data=="string"?this.streamText(t.data):this.streamVideo(t.data)},this.connection.onerror=t=>{console.error("WebSocket error:",t)},this.connection.onclose=()=>{console.log("WebSocket connection closed")}}becomePyaara(){this.connection.send(this.userData().username==""?"\u092A\u094D\u092F\u093E\u0930\u093E":this.userData().username)}checkLength(){this.usertext.length==15&&this.usertext.pop()}sendText(e){this.checkLength(),this.usertext.unshift(`@${this.userData().username==""?"\u092A\u094D\u092F\u093E\u0930\u093E":this.userData().username} : ${e.trim()}`),this.connection.send(`T9${e.trim()}`)}streamText(e){e=="ignore"||(e=="locked"?(this.startStreamDisabled=!0,this.stopStreamDisabled=!0):e=="unlocked"?(this.startStreamDisabled=!1,this.stopStreamDisabled=!0,this.ms.endOfStream()):e.includes("T9")?(this.checkLength(),this.usertext.unshift(e.split("T9")[1])):this.userName=e.split(","))}streamVideo(e){return x(this,null,function*(){this.showStreamedVideo=!1;let t=yield e.arrayBuffer();this.ms.readyState==="open"&&typeof this.sb<"u"&&typeof e<"u"&&this.sb.appendBuffer(t)})}startStream(){this.showStreamerVideo=!1,this.connection.send("locked"),navigator.mediaDevices.getUserMedia({audio:{channelCount:2,echoCancellation:!1,noiseSuppression:!1},video:{facingMode:"environment",frameRate:{ideal:24}}}).then(e=>{this.startStreamDisabled=!0,this.stopStreamDisabled=!1,this.streamerVideo.nativeElement.srcObject=e,this.mediaRecorder=new MediaRecorder(e,{audioBitsPerSecond:30*1e3,videoBitsPerSecond:300*1e3,mimeType:'video/webm; codecs="vp8, opus"'}),this.mediaRecorder.ondataavailable=t=>{this.connection.send(t.data)},this.mediaRecorder.onstop=()=>{e.getTracks().forEach(t=>t.stop()),this.connection.send("unlocked"),this.showStreamerVideo=!1,this.startStreamDisabled=!1,this.stopStreamDisabled=!0},this.mediaRecorder.start(200)})}endStream(){this.mediaRecorder.stop()}setTime(){this.streamedVideo.nativeElement.currentTime=this.streamedVideo.nativeElement.seekable.end(0),this.streamedVideo.nativeElement.currentTime>0&&!this.streamedVideo.nativeElement.paused&&!this.streamedVideo.nativeElement.ended?setTimeout(this.setTime,1e4):this.streamedVideo.nativeElement.paused&&setTimeout(this.setTime,1e3)}ngOnDestroy(){this.connection.close()}static \u0275fac=function(t){return new(t||o)(f(R),f($))};static \u0275cmp=C({type:o,selectors:[["app-livestream"]],viewQuery:function(t,n){if(t&1&&(g(q,7),g(G,7)),t&2){let d;y(d=_())&&(n.streamerVideo=d.first),y(d=_())&&(n.streamedVideo=d.first)}},standalone:!0,features:[L],decls:37,vars:6,consts:[["streamervideo",""],["streamedvideo",""],["message",""],[2,"display","flex","justify-content","center"],["height","300px","width","400px","autoplay","","controls","","muted","",1,"center",3,"hidden"],["height","300px","width","400px","autoplay","","controls","",1,"center",3,"hidden"],[1,"center",3,"hidden"],["mat-stroked-button","","color","accent",3,"click","disabled"],["mat-stroked-button","","color","error",3,"click","disabled"],[1,"center"],[2,"width","80%","margin","auto","text-align","center"],["aria-label","Fish selection"],["matInput",""],["mat-stroked-button","","color","primary",3,"click"]],template:function(t,n){if(t&1){let d=M();r(0,"div")(1,"div",3),l(2,"video",4,0)(4,"video",5,1),i(),l(6,"br"),r(7,"div",6)(8,"button",7),u("click",function(){return c(d),h(n.startStream())}),a(9,"Go Live"),i(),a(10," \xA0 "),r(11,"button",8),u("click",function(){return c(d),h(n.endStream())}),a(12,"End Live"),i()(),l(13,"br"),r(14,"p",9),a(15,"Un-mute the video."),i(),r(16,"p",9),a(17,"If stream stops , try pulling the seek button till the end."),i(),r(18,"p",9),a(19,"Only one logged in user can be live at a time. "),i(),r(20,"p",9),a(21,"Refresh before going live if someone was live before you. "),i(),r(22,"div",10)(23,"mat-chip-set",11)(24,"mat-chip"),a(25,"Users online :"),i(),S(26,Y,2,1,"mat-chip",null,v),i(),r(28,"mat-form-field")(29,"mat-label"),a(30,"message:"),i(),l(31,"input",12,2),i(),r(33,"button",13),u("click",function(){c(d);let T=I(32);return h([n.sendText(T.value),T.value=""])}),a(34,"Send"),i(),S(35,z,2,1,"h2",null,v),i()()}t&2&&(m("@slideFromTop",void 0),s(2),m("hidden",n.showStreamerVideo),s(2),m("hidden",n.showStreamedVideo),s(3),m("hidden",!n.loggedIn()),s(),m("disabled",n.startStreamDisabled),s(3),m("disabled",n.stopStreamDisabled),s(15),b(n.userName),s(9),b(n.usertext))},dependencies:[U,F,A,N,P,j,Q],styles:["video[_ngcontent-%COMP%]{margin:auto}"],data:{animation:[O("slideFromTop",[E(":enter",[p({opacity:0}),D("500ms ease-out",p({opacity:1}))]),E(":leave",[D("300ms ease-in",p({transform:"translateY(-100%)",opacity:0}))])])]}})};export{W as LivestreamComponent};
