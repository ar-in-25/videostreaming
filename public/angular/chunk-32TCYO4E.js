import{a as U}from"./chunk-TJF7TCZW.js";import{b as A}from"./chunk-76NFRR3S.js";import{a as B,d as I}from"./chunk-ON2JRT6O.js";import{a as w,c as O}from"./chunk-WZDNHQD2.js";import{f as y}from"./chunk-TAT732FB.js";import{Eb as C,Hb as m,Jb as c,Rb as r,Sb as k,Wb as D,Ya as s,Za as u,ha as f,mb as g,ob as p,pc as x,qa as d,ra as h,tb as v,ub as _,wb as b,xb as S,yb as o,zb as a}from"./chunk-J7P67657.js";function M(i,t){if(i&1&&(o(0,"mat-chip"),r(1),a()),i&2){let e=t.$implicit;s(),k("@"+e)}}function R(i,t){if(i&1){let e=C();o(0,"mat-chip-set",0),b(1,M,2,1,"mat-chip",null,_),a(),o(3,"button",1),m("click",function(){d(e);let l=c();return h(l.sendAudio())}),r(4,"Start Recording"),a(),o(5,"button",2),m("click",function(){d(e);let l=c();return h(l.stopAudio())}),r(6,"Send Recording"),a()}if(i&2){let e=c();s(),S(e.allUsers),s(2),p("disabled",e.sendAudioDisabled),s(2),p("disabled",e.stopAudioDisabled)}}function L(i,t){i&1&&(o(0,"h1"),r(1,"Login to use"),a())}var T=class i{constructor(t,e){this._authenticateService=t;this._matSnackBar=e;this.loggedIn=this._authenticateService.loggedIn,this.userData=this._authenticateService.user_data,x(()=>{this.loggedIn()&&(this.allUsers.indexOf(this.userData().username)==-1&&this.allUsers.push(this.userData().username),this.connect()),this.loggedIn()||this.connection&&this.connection.close()})}mediaRecorder;audioChunks=[];connection;sendAudioDisabled=!0;stopAudioDisabled=!0;loggedIn;userData;allUsers=[];ngOnInit(){this.loggedIn()&&(this.allUsers.indexOf(this.userData().username)==-1&&this.allUsers.push(this.userData().username),this.connect())}connect(){let t=y.wsBaseUrl;this.connection=new WebSocket(t),this.connection.onopen=()=>{console.log("connection open",this.connection.readyState),this.sendAudioDisabled=!1,this.connection.readyState==1&&this.connection.send(JSON.stringify({event:"connect",name:this.userData().username}))},this.connection.onmessage=e=>{console.log("message rece"),typeof e.data=="string"?this.playThatText(JSON.parse(e.data)):this.playThatSong(e.data)},this.connection.onerror=e=>{console.error("WebSocket error:",e)},this.connection.onclose=()=>{console.log("WebSocket connection closed")}}sendAudio(){navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(t=>{this.sendAudioDisabled=!0,this.stopAudioDisabled=!1,this.mediaRecorder=new MediaRecorder(t,{audioBitsPerSecond:1e4}),this.mediaRecorder.ondataavailable=e=>{this.audioChunks.push(e.data)},this.mediaRecorder.onstop=()=>{let e=new Blob(this.audioChunks,{type:"audio/ogg"});this.audioChunks=[],this.connection.send(e),t.getTracks().forEach(n=>n.stop())},this.mediaRecorder.start(100)})}stopAudio(){this.sendAudioDisabled=!1,this.stopAudioDisabled=!0,this.mediaRecorder.stop()}playThatSong(t){let e=URL.createObjectURL(t);new Audio(e).play()}playThatText(t){switch(t.event){case"joined":this._matSnackBar.open(`@${t.name} joined`,"OK",{duration:1500}),this.allUsers.push(t.name);break;case"left":this._matSnackBar.open(`@${t.name} left`,"OK",{duration:1500}),this.allUsers.splice(this.allUsers.indexOf(t.name),1);break}}ngOnDestroy(){this.connection.close()}static \u0275fac=function(e){return new(e||i)(u(A),u(U))};static \u0275cmp=f({type:i,selectors:[["app-livechat"]],standalone:!0,features:[D],decls:2,vars:1,consts:[["aria-label","Fish selection"],["mat-stroked-button","","color","accent",3,"click","disabled"],["mat-stroked-button","","color","error",3,"click","disabled"]],template:function(e,n){e&1&&g(0,R,7,2)(1,L,2,0,"h1"),e&2&&v(n.loggedIn()?0:1)},dependencies:[I,B,O,w]})};export{T as a};
